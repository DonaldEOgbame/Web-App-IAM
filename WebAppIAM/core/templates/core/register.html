<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
        .container { max-width:500px; margin:40px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align:center; }
        form { display:flex; flex-direction:column; }
        label { margin-top:10px; }
        input, select { padding:8px; border:1px solid #ccc; border-radius:4px; margin-top:5px; }
        button { margin-top:15px; padding:10px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        button:hover { background:#1e7e34; }
        .messages { margin-bottom:15px; }
        .messages li { list-style:none; padding:10px; border-radius:4px; margin-bottom:5px; }
        .messages .error { background:#f8d7da; color:#721c24; }
        .messages .success { background:#d4edda; color:#155724; }
    </style>
</head>
<body>
<div class="container">
    <h1>Register</h1>
    {% if messages %}
    <ul class="messages">
        {% for m in messages %}<li class="{{ m.tags }}">{{ m }}</li>{% endfor %}
    </ul>
    {% endif %}

    {% if show_profile_completion %}
        <h2>Complete Your Profile</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Continue</button>
        </form>
    {% elif enrollment_type == 'biometric' %}
        <h2>Enroll Biometrics</h2>
        <form id="faceEnroll" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="face_data">Face image</label>
            <input type="file" id="face_data" name="face_data" accept="image/*">
            <button type="submit">Enroll Face</button>
        </form>
        <hr>
        <button id="enrollFingerprint" type="button">Enroll Fingerprint</button>
    {% else %}
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Register</button>
        </form>
    {% endif %}
</div>
<script>
(function(){
    const csrftoken = '{{ csrf_token }}';
    {% if enrollment_type == 'biometric' %}
    const initialOptions = {{ webauthn_options|default:'null'|safe }};

    async function startFingerprint(opts){
        try{
            let options = opts;
            if(!options){
                const resp = await fetch('{% url "core:webauthn_registration_options" %}', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken}
                });
                options = await resp.json();
            }
            ['challenge','user.id'].forEach(k=>{ if(options[k]) options[k]=Uint8Array.from(atob(options[k]),c=>c.charCodeAt(0)); });
            if(options.excludeCredentials){
                options.excludeCredentials = options.excludeCredentials.map(c=>{ c.id=Uint8Array.from(atob(c.id),ch=>ch.charCodeAt(0)); return c; });
            }
            const cred = await navigator.credentials.create({publicKey: options});
            const data = {
                id: cred.id,
                rawId: btoa(String.fromCharCode(...new Uint8Array(cred.rawId))),
                type: cred.type,
                response: {
                    clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(cred.response.clientDataJSON))),
                    attestationObject: btoa(String.fromCharCode(...new Uint8Array(cred.response.attestationObject)))
                }
            };
            const verifyResp = await fetch('{% url "core:webauthn_registration_verify" %}', {
                method: 'POST',
                headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
                body: JSON.stringify(data)
            });
            const result = await verifyResp.json();
            if(result.status === 'success'){
                if(result.redirect){ window.location.href = result.redirect; }
                else alert('Fingerprint enrollment successful');
            }else{
                alert(result.message || 'Enrollment failed');
            }
        }catch(e){
            alert('Fingerprint enrollment failed');
        }
    }

    document.getElementById('enrollFingerprint').addEventListener('click', function(){
        startFingerprint(initialOptions);
    });
    {% endif %}
})();
</script>
</body>
</html>
