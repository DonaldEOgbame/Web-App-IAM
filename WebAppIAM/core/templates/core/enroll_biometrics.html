{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enroll Biometrics</title>

    <style>
        :root{
            --bg:#0f1115;
            --bg-soft:#14171c;
            --surface:#1a1d23;
            --surface-2:#1f232a;
            --border:#2a2f38;
            --text:#e5e7eb;
            --text-dim:#9ca3af;
            --primary:#8b5cf6;
            --primary-weak:rgba(139,92,246,.15);
            --success:#22c55e;
            --warning:#fbbf24;
            --danger:#ef4444;
            --radius:16px;
            --shadow:0 12px 32px rgba(0,0,0,.28);
            --transition:180ms ease;
        }

        *{ box-sizing:border-box; }
        html, body{
            margin:0;
            min-height:100%;
            background:var(--bg);
            color:var(--text);
            font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
            line-height:1.5;
        }

        a{ color:var(--primary); }

        .wrap{
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:32px 16px;
        }

        .card{
            width:100%;
            max-width:760px;
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            padding:32px 28px;
            position:relative;
        }

        .hello{
            margin:0 0 24px;
            text-align:center;
            font-weight:800;
            font-size:1.6rem;
            background:linear-gradient(90deg,var(--primary),#a855f7,var(--primary));
            background-size:200% 100%;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            animation:shimmer 2.5s infinite, fadeSlideIn 320ms ease forwards;
            opacity:0;
        }
        @keyframes shimmer{
            0%{ background-position:0% 50%; }
            100%{ background-position:200% 50%; }
        }
        @keyframes fadeSlideIn{
            from{ opacity:0; transform:translateY(6px); }
            to{ opacity:1; transform:translateY(0); }
        }

        .tabs{
            display:flex;
            gap:8px;
            background:var(--surface-2);
            border:1px solid var(--border);
            border-radius:12px;
            padding:4px;
            margin-bottom:20px;
        }
        .tab-btn{
            flex:1;
            background:transparent;
            color:var(--text-dim);
            border:none;
            border-radius:8px;
            padding:10px 12px;
            cursor:pointer;
            transition:background var(--transition), color var(--transition);
        }
        .tab-btn.active{
            background:var(--primary);
            color:#fff;
        }

        .section{
            display:none;
            opacity:0;
            transform:translateY(8px);
        }
        .section.active{
            display:block;
            animation:fadeSlideIn 240ms var(--transition) forwards;
        }

        .video-box{
            background:var(--bg-soft);
            border:1px dashed var(--border);
            border-radius:12px;
            padding:12px;
            display:flex;
            justify-content:center;
            align-items:center;
            overflow:hidden;
        }
        video{
            width:100%;
            max-height:360px;
            border-radius:8px;
            background:#000;
        }
        canvas{ display:none; max-width:100%; border-radius:8px; }

        form{
            display:grid;
            gap:16px;
        }

        .btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:12px 16px;
            border:none;
            border-radius:10px;
            background:var(--primary);
            color:#fff;
            font-weight:600;
            cursor:pointer;
            transition:opacity .15s ease, transform .15s ease;
        }
        .btn:hover{ opacity:.95; }
        .btn:active{ transform:translateY(1px); }
        .btn[disabled]{
            opacity:.5;
            cursor:not-allowed;
        }
        .btn-outline{
            background:transparent;
            color:var(--text);
            border:1px solid var(--border);
        }
        .btn-outline:hover{
            background:var(--surface-2);
        }

        .submitting{
            opacity:.6;
            pointer-events:none;
            position:relative;
        }
        .submitting::after{
            content:"";
            width:18px;height:18px;
            border:2px solid rgba(255,255,255,.4);
            border-top-color:#fff;
            border-radius:50%;
            animation:spin .6s linear infinite;
            position:absolute;
            right:14px; top:50%;
            transform:translateY(-50%);
        }
        @keyframes spin{
            to{ transform:translateY(-50%) rotate(360deg); }
        }

        .status{
            margin-top:8px;
            font-size:.9rem;
            color:var(--text-dim);
        }
        .status.success{ color:var(--success); }
        .status.error{ color:var(--danger); }
        .status.warning{ color:var(--warning); }

        /* simple list for progress */
        #progressList{
            list-style: none;
            padding: 0;
            margin: 0 0 16px;
        }
        #progressList li{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:6px 10px;
            background:var(--surface-2);
            border-radius:8px;
            margin-bottom:6px;
            font-size:.9rem;
        }
        #progressList li span[data-state="done"]{
            color:var(--success);
            font-weight:600;
        }

        .fp-icon, .cam-icon{
            width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1 class="hello">Enroll your biometrics, {% firstof request.user.first_name request.user.username %} ðŸ”’</h1>

        <p role="note" class="status" style="margin-bottom:16px">
            Biometric enrollment is <strong>required</strong> to continue. You can enroll your <strong>face</strong> (camera only) and/or a <strong>platform authenticator</strong> (fingerprint / passkey via WebAuthn). Your biometric data is securely stored and used only for authentication.
            <a href="{% url 'core:privacy' %}" target="_blank" rel="noopener">Learn more</a>.
        </p>

        <ul id="progressList" class="status" aria-live="polite">
            <li id="prog-face">Face <span data-state="{{ face_done|yesno:'done,pending' }}">{{ face_done|yesno:'Completed,Pending' }}</span></li>
            <li id="prog-webauthn">Fingerprint / Passkey <span data-state="{{ webauthn_done|yesno:'done,pending' }}">{{ webauthn_done|yesno:'Completed,Pending' }}</span></li>
        </ul>

        <button id="continueBtn" class="btn btn-outline" type="button" {% if require_both %}{% if not face_done or not webauthn_done %}disabled{% endif %}{% else %}{% if not face_done and not webauthn_done %}disabled{% endif %}{% endif %}>
            Continue to profile completion
        </button>

        <div class="tabs" role="tablist">
            <button id="tab-face" class="tab-btn {% if not webauthn_done %}active{% endif %}" data-target="face-sec" role="tab" aria-selected="{% if not webauthn_done %}true{% else %}false{% endif %}">
                <svg class="cam-icon" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="12" cy="12" r="3"></circle></svg>
                Face
            </button>
            <button id="tab-fp" class="tab-btn {% if webauthn_done and not face_done %}active{% endif %}" data-target="fp-sec" role="tab" aria-selected="{% if webauthn_done and not face_done %}true{% else %}false{% endif %}">
                <svg class="fp-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 11a4 4 0 0 0-4 4v1"></path><path d="M12 11a4 4 0 0 1 4 4v1"></path><path d="M12 11V9"></path><path d="M8 5a8 8 0 0 1 8 0"></path><path d="M5 8a11 11 0 0 1 14 0"></path><path d="M3 12a15 15 0 0 1 18 0"></path><path d="M6 16a11 11 0 0 1 12 0"></path></svg>
                Fingerprint / Passkey
            </button>
        </div>

        <!-- FACE ENROLLMENT -->
        <section id="face-sec" class="section {% if not webauthn_done %}active{% endif %}" role="tabpanel" aria-labelledby="tab-face">
            <form id="faceEnroll" method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                <div class="video-box" aria-label="Camera preview">
                    <video id="enrollVideo" autoplay playsinline muted></video>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="enrollFaceBtn" class="btn" type="submit" {% if face_done %}disabled{% endif %}>
                        <svg class="cam-icon" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2"></rect><circle cx="12" cy="12" r="3"></circle></svg>
                        Capture &amp; Enroll Face
                    </button>
                    <button id="takePreview" class="btn btn-outline" type="button" {% if face_done %}disabled{% endif %}>Preview Snapshot</button>
                </div>
                <canvas id="snapshotCanvas"></canvas>
                <p id="faceStatus" class="status" aria-live="polite" role="status"></p>
            </form>
        </section>

        <!-- FINGERPRINT / PASSKEY (WebAuthn) -->
        <section id="fp-sec" class="section {% if webauthn_done and not face_done %}active{% endif %}" role="tabpanel" aria-labelledby="tab-fp">
            <p class="status">Register a <strong>platform authenticator</strong> (e.g., fingerprint, Windows Hello, Touch ID) using WebAuthn.</p>
            <button id="enrollFingerprint" class="btn" type="button" {% if webauthn_done %}disabled{% endif %}>
                <svg class="fp-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 11a4 4 0 0 0-4 4v1"></path><path d="M12 11a4 4 0 0 1 4 4v1"></path><path d="M12 11V9"></path><path d="M8 5a8 8 0 0 1 8 0"></path><path d="M5 8a11 11 0 0 1 14 0"></path><path d="M3 12a15 15 0 0 1 18 0"></path><path d="M6 16a11 11 0 0 1 12 0"></path></svg>
                Enroll Fingerprint / Passkey
            </button>
            <p id="fpStatus" class="status" aria-live="polite" role="status"></p>
        </section>
    </div>
</div>

<script>
(function(){
    // Initial state from backend
    const initialState = {
        faceDone: {{ face_done|yesno:"true,false" }},
        webauthnDone: {{ webauthn_done|yesno:"true,false" }},
        requireBoth: {{ require_both|yesno:"true,false" }},
        profileRedirect: "{% url 'core:profile_complete' %}",
        webauthnOptions: {{ webauthn_options|default:'null'|safe }}
    };

    // ----- Tabs -----
    const tabs = document.querySelectorAll('.tab-btn');
    const sections = document.querySelectorAll('.section');
    tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
            tabs.forEach(b=>{
                b.classList.toggle('active', b === btn);
                b.setAttribute('aria-selected', b === btn ? 'true':'false');
            });
            sections.forEach(sec=>{
                sec.classList.toggle('active', sec.id === btn.dataset.target);
            });
        });
    });

    // Progress & continue
    const continueBtn = document.getElementById('continueBtn');
    function maybeEnableContinue(){
        const done = initialState.requireBoth
            ? (initialState.faceDone && initialState.webauthnDone)
            : (initialState.faceDone || initialState.webauthnDone);
        if(continueBtn) continueBtn.disabled = !done;
    }
    function markDone(step){
        const el = document.querySelector(`#prog-${step} span`);
        if(el){
            el.textContent = 'Completed';
            el.dataset.state = 'done';
            el.style.color = 'var(--success)';
        }
        if(step === 'face') initialState.faceDone = true;
        if(step === 'webauthn') initialState.webauthnDone = true;
        maybeEnableContinue();
    }
    maybeEnableContinue();
    continueBtn?.addEventListener('click', () => {
        window.location.href = initialState.profileRedirect;
    });

    // CSRF
    function getCsrfToken() {
        const el = document.querySelector('input[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }
    const csrftoken = getCsrfToken();

    // ----- Face Enroll -----
    const enrollForm = document.getElementById('faceEnroll');
    const enrollVideo = document.getElementById('enrollVideo');
    const enrollBtn = document.getElementById('enrollFaceBtn');
    const takePreviewBtn = document.getElementById('takePreview');
    const snapshotCanvas = document.getElementById('snapshotCanvas');
    const faceStatus = document.getElementById('faceStatus');

    function setFaceStatus(msg, type){
        if(!faceStatus) return;
        faceStatus.textContent = msg;
        faceStatus.className = 'status ' + (type || '');
    }

    if(enrollVideo){
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
            setFaceStatus('Camera not supported in this browser.', 'error');
        } else {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "user",
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 }
                }
            })
            .then(stream => {
                enrollVideo.srcObject = stream;
            })
            .catch((err) => {
                setFaceStatus('Unable to access camera: ' + (err?.message || err), 'error');
            });
        }
    }

    function isResolutionOkay(w, h) {
        return w >= 640 && h >= 480;
    }

    function isFrameBrightEnough(ctx, w, h) {
        try {
            const data = ctx.getImageData(0, 0, w, h).data;
            let sum = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += 0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2];
            }
            const avg = sum / (data.length / 4);
            return avg > 60; // tune threshold
        } catch {
            return true; // fallback if getImageData fails
        }
    }

    if(takePreviewBtn && snapshotCanvas){
        takePreviewBtn.addEventListener('click', () => {
            if(!enrollVideo.videoWidth){
                setFaceStatus('Video not ready yet, please wait...', 'error');
                return;
            }
            snapshotCanvas.width = enrollVideo.videoWidth;
            snapshotCanvas.height = enrollVideo.videoHeight;
            const ctx = snapshotCanvas.getContext('2d');
            ctx.drawImage(enrollVideo,0,0,snapshotCanvas.width,snapshotCanvas.height);
            snapshotCanvas.style.display = 'block';
            setFaceStatus('Snapshot captured. You can now enroll.', 'success');
        });
    }

    if(enrollForm){
        enrollForm.addEventListener('submit', async function(e){
            e.preventDefault();
            if(initialState.faceDone){
                setFaceStatus('Face already enrolled.', 'success');
                return;
            }
            setFaceStatus('Capturing and uploading...', '');
            enrollBtn?.classList.add('submitting');
            try{
                const canvas = document.createElement('canvas');
                canvas.width = enrollVideo.videoWidth || 640;
                canvas.height = enrollVideo.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(enrollVideo,0,0,canvas.width,canvas.height);

                if (!isResolutionOkay(canvas.width, canvas.height)) {
                    setFaceStatus('Image too small. Ensure good lighting and use a higher resolution camera.', 'error');
                    return;
                }
                if (!isFrameBrightEnough(ctx, canvas.width, canvas.height)) {
                    setFaceStatus('Image too dark. Increase lighting and try again.', 'error');
                    return;
                }

                canvas.toBlob(async function(blob){
                    const data = new FormData();
                    data.append('face_data', blob, 'face.png');

                    const resp = await fetch('', {
                        method:'POST',
                        headers:{'X-CSRFToken': csrftoken},
                        body: data
                    });

                    if(resp.redirected){
                        // Server decided we're done (and likely logged audit event)
                        window.location.href = resp.url;
                        return;
                    }

                    if(resp.ok){
                        setFaceStatus('Face enrollment successful', 'success');
                        markDone('face');
                        enrollBtn.disabled = true;
                        takePreviewBtn.disabled = true;
                    }else{
                        const text = await resp.text();
                        setFaceStatus('Enrollment failed: ' + text, 'error');
                    }
                }, 'image/png');
            }catch(err){
                setFaceStatus('Enrollment failed: ' + (err?.message || err), 'error');
            }finally{
                enrollBtn?.classList.remove('submitting');
            }
        });
    }

    // ----- Fingerprint / Passkey (WebAuthn) -----
    const fpBtn = document.getElementById('enrollFingerprint');
    const fpStatus = document.getElementById('fpStatus');

    function setFpStatus(msg, type){
        if(!fpStatus) return;
        fpStatus.textContent = msg;
        fpStatus.className = 'status ' + (type || '');
    }

    function b64UrlToBuf(b64){
        b64 = b64.replace(/-/g, '+').replace(/_/g, '/');
        const pad = b64.length % 4;
        if(pad) b64 += '='.repeat(4 - pad);
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }
    function bufToB64Url(buf){
        const bin = String.fromCharCode(...new Uint8Array(buf));
        return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
    }

    async function startFingerprint(opts){
        if(initialState.webauthnDone){
            setFpStatus('Already enrolled.', 'success');
            return;
        }
        try{
            if(window.isSecureContext === false){
                setFpStatus('WebAuthn requires HTTPS.', 'error');
                return;
            }
            if(!('credentials' in navigator) || !('create' in navigator.credentials)){
                setFpStatus('WebAuthn not supported in this browser.', 'error');
                return;
            }

            setFpStatus('Requesting authenticator...', '');
            fpBtn.classList.add('submitting');

            let options = opts;
            if(!options){
                const resp = await fetch('{% url "core:webauthn_registration_options" %}', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken}
                });
                options = await resp.json();
            }

            // Convert from base64url to ArrayBuffers
            options.challenge = b64UrlToBuf(options.challenge);
            options.user.id = b64UrlToBuf(options.user.id);
            if(options.excludeCredentials){
                options.excludeCredentials = options.excludeCredentials.map(c => {
                    return { ...c, id: b64UrlToBuf(c.id) };
                });
            }

            const cred = await navigator.credentials.create({publicKey: options});
            if(!cred){
                setFpStatus('No credential created.', 'error');
                return;
            }

            const data = {
                id: cred.id,
                rawId: bufToB64Url(cred.rawId),
                type: cred.type,
                response: {
                    clientDataJSON: bufToB64Url(cred.response.clientDataJSON),
                    attestationObject: bufToB64Url(cred.response.attestationObject)
                }
            };

            setFpStatus('Verifying with server...', '');

            const verifyResp = await fetch('{% url "core:webauthn_registration_verify" %}', {
                method: 'POST',
                headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
                body: JSON.stringify(data)
            });

            const result = await verifyResp.json();
            if(result.status === 'success'){
                setFpStatus('Fingerprint / Passkey enrollment successful!', 'success');
                markDone('webauthn');
                fpBtn.disabled = true;
                if(result.redirect){
                    window.location.href = result.redirect;
                }
            }else{
                setFpStatus(result.message || 'Enrollment failed', 'error');
            }
        }catch(e){
            if(e && e.name === 'NotAllowedError'){
                setFpStatus('Operation cancelled or timed out. Please try again.', 'error');
            }else if(window.isSecureContext === false){
                setFpStatus('WebAuthn requires HTTPS.', 'error');
            }else{
                setFpStatus('Fingerprint enrollment failed: ' + (e?.message || e), 'error');
            }
            console.error(e);
        }finally{
            fpBtn.classList.remove('submitting');
        }
    }

    if(fpBtn){
        fpBtn.addEventListener('click', function(){
            startFingerprint(initialState.webauthnOptions);
        });
    }

    // Make sure initial UI state is reflected
    if(initialState.faceDone) markDone('face');
    if(initialState.webauthnDone) markDone('webauthn');
})();
</script>
</body>
</html>
